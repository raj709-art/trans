<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Government Budget Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f9;
      color: #333;
      padding: 20px;
      margin: 0;
    }
    h2 {
      color: #2c3e50;
    }
    .container {
      max-width: 800px;
      margin: auto;
    }
    input, button {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #2c3e50;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #1a242f;
    }
    .transactions {
      margin-top: 30px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .transaction {
      border-bottom: 1px solid #eee;
      padding: 10px 0;
    }
    .transaction:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Government Budget Tracker</h2>
    <button onclick="connectWallet()">Connect Wallet</button>

    <h3>Allocate Budget</h3>
    <input type="text" id="deptIdAlloc" placeholder="Department ID">
    <input type="number" id="amountAlloc" placeholder="Amount in Wei">
    <button onclick="allocateBudget()">Allocate Budget</button>

    <h3>Spend Funds</h3>
    <input type="text" id="deptIdSpend" placeholder="Department ID">
    <input type="number" id="amountSpend" placeholder="Amount in Wei">
    <input type="text" id="purposeSpend" placeholder="Purpose">
    <button onclick="spendFunds()">Spend Funds</button>

    <h3>Get Budget Details</h3>
    <input type="text" id="deptIdDetails" placeholder="Department ID">
    <button onclick="getBudgetDetails()">Get Details</button>
    <div id="budgetInfo"></div>

    <h3>Transaction History</h3>
    <button onclick="loadTransactions()">Load Transactions</button>
    <div id="transactions" class="transactions"></div>
  </div>

  <script>
    const contractAddress = "0x02b49f6f9d1281C07F044cd9A8d383B2998d0454";
    const contractABI = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "deptId",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "allocateBudget",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "deptId",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "BudgetAllocated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "deptId",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "purpose",
				"type": "string"
			}
		],
		"name": "FundsSpent",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "deptId",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "purpose",
				"type": "string"
			}
		],
		"name": "spendFunds",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "budgets",
		"outputs": [
			{
				"internalType": "string",
				"name": "deptId",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "spentAmount",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "exists",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "deptId",
				"type": "string"
			}
		],
		"name": "getBudgetDetails",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "allocated",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "spent",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "remaining",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "index",
				"type": "uint256"
			}
		],
		"name": "getTransaction",
		"outputs": [
			{
				"internalType": "string",
				"name": "deptId",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "purpose",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getTransactionCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "transactions",
		"outputs": [
			{
				"internalType": "string",
				"name": "deptId",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "spender",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "purpose",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]; // Paste your ABI array here

    let web3;
    let contract;
    let accounts;

    async function connectWallet() {
      try {
        if (window.ethereum) {
          web3 = new Web3(window.ethereum);
          await window.ethereum.request({ method: "eth_requestAccounts" });
          accounts = await web3.eth.getAccounts();
          contract = new web3.eth.Contract(contractABI, contractAddress);
          alert("Wallet connected: " + accounts[0]);
        } else {
          alert("MetaMask not detected. Please install MetaMask.");
        }
      } catch (error) {
        console.error("Failed to connect to MetaMask", error);
        alert("Failed to connect to MetaMask");
      }
    }

    async function allocateBudget() {
      try {
        const deptId = document.getElementById("deptIdAlloc").value;
        const amount = document.getElementById("amountAlloc").value;
        await contract.methods.allocateBudget(deptId, amount).send({ from: accounts[0] });
        alert("Budget allocated");
      } catch (err) {
        console.error(err);
        alert("Error allocating budget");
      }
    }

    async function spendFunds() {
      try {
        const deptId = document.getElementById("deptIdSpend").value;
        const amount = document.getElementById("amountSpend").value;
        const purpose = document.getElementById("purposeSpend").value;
        await contract.methods.spendFunds(deptId, amount, purpose).send({ from: accounts[0] });
        alert("Funds spent");
      } catch (err) {
        console.error(err);
        alert("Error spending funds");
      }
    }

    async function getBudgetDetails() {
      try {
        const deptId = document.getElementById("deptIdDetails").value;
        const result = await contract.methods.getBudgetDetails(deptId).call();
        document.getElementById("budgetInfo").innerHTML = `
          <p><strong>Allocated:</strong> ${result.allocated} Wei</p>
          <p><strong>Spent:</strong> ${result.spent} Wei</p>
          <p><strong>Remaining:</strong> ${result.remaining} Wei</p>
        `;
      } catch (err) {
        console.error(err);
        alert("Error fetching budget details");
      }
    }

    async function loadTransactions() {
      try {
        const txCount = await contract.methods.getTransactionCount().call();
        const container = document.getElementById("transactions");
        container.innerHTML = "";
        for (let i = 0; i < txCount; i++) {
          const tx = await contract.methods.getTransaction(i).call();
          const timestamp = Number(tx.timestamp);
          const dateStr = isNaN(timestamp) ? "N/A" : new Date(timestamp * 1000).toLocaleString();
          container.innerHTML += `
            <div class="transaction">
              <p><strong>Dept:</strong> ${tx.deptId}</p>
              <p><strong>Amount:</strong> ${tx.amount} Wei</p>
              <p><strong>Spender:</strong> ${tx.spender}</p>
              <p><strong>Purpose:</strong> ${tx.purpose}</p>
              <p><strong>Time:</strong> ${dateStr}</p>
            </div>
          `;
        }
      } catch (err) {
        console.error(err);
        alert("Error loading transactions");
      }
    }
  </script>
</body>
</html>
